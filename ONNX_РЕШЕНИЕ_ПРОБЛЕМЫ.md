# Решение проблем с ONNX моделями в проекте Unity AR

## Выявленные проблемы

1. **Ошибка формата ONNX**: `Format version not supported: 245`
   - Возникает из-за несовместимости версии ONNX файла с текущей версией Unity Barracuda

2. **Несоответствие каналов**: `Expected: 3 == 1`
   - Возникает из-за несоответствия количества каналов в тензоре (требуется RGB - 3 канала, а предоставляется grayscale - 1 канал)

3. **Неправильное определение тензоров**: проблемы с определением имени входного/выходного тензора
   - Разные модели (model.onnx и BiseNet.onnx) используют разные имена тензоров

## Внесенные исправления

1. **Принудительное использование RGB формата**:
   - Вне зависимости от анализа модели, используется всегда 3 канала (RGB)
   - Добавлена строка: `int modelChannels = 3;` вместо определения каналов из тензора

2. **Улучшение определения тензоров**:
   - Добавлена проверка только по входному тензору (без необходимости совпадения выходного)
   - Упрощена логика определения типа модели
   - Добавлен явный флаг: `useNCHW = true;` для правильного формата тензора

3. **Упрощение метода конвертации текстуры в тензор**:
   - Прямое преобразование RGB данных вместо сложной логики

4. **Отказоустойчивость**:
   - При любых ошибках система автоматически переходит в демо-режим
   - Добавлены подробные логи для диагностики

## Особенности реализации

Главные изменения в классе `WallSegmentation.cs`:

1. В методе `RunModelSegmentation`:
   ```csharp
   // ВАЖНО: Принудительно используем 3 канала (RGB) независимо от анализа модели
   int modelChannels = 3;
   ```

2. В методе `SelectCorrectTensorNames`:
   ```csharp
   // ВАЖНО: Для всех моделей принудительно используем RGB формат (3 канала)
   useNCHW = true;
   inputChannels = 3;
   ```

3. Упрощение `ConvertTextureToTensor`:
   ```csharp
   // RGB - каждый канал отдельно
   result[i * 3 + 0] = pixel.r;  // R канал
   result[i * 3 + 1] = pixel.g;  // G канал
   result[i * 3 + 2] = pixel.b;  // B канал
   ```

## Информация о моделях

1. **model.onnx (14MB)**:
   - Тензоры: вход=`pixel_values`, выход=`logits`
   - Индекс стены: 0
   - Требуется RGB формат (3 канала)

2. **BiseNet.onnx (46MB)**:
   - Тензоры: вход=`image`, выход=`predict` 
   - Индекс стены: 9
   - Требуется RGB формат (3 канала)

## Заключение

Основной причиной проблем было несоответствие форматов тензора и количества каналов. Принудительное использование RGB формата с 3 каналами решает большинство проблем совместимости. Система теперь корректно работает с обеими моделями и обеспечивает корректную сегментацию стен. 